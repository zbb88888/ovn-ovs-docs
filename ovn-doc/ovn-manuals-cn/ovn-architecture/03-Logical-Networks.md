# 逻辑网络

OVN 中的逻辑网络概念包括逻辑交换机和逻辑路由器，分别是针对以太网交换机和 IP 路由器的逻辑版本。就像它们的物理表亲一样，逻辑交换机和路由器可以连接成复杂的拓扑结构。逻辑交换机和路由器通常是纯逻辑实体，也就是说，它们不关联或绑定到任何物理位置，并且它们是在参与 OVN 的每个管理程序上以分布式方式实现的。

逻辑交换机端口 (LSP) 是进出逻辑交换机的连接点。逻辑交换机端口有很多种。最普通的一种代表 VIF，即 VM 或容器的连接点。VIF 逻辑端口与 VM 的物理位置相关联，这可能会随着 VM 的迁移而改变。（VIF 逻辑端口可以关联到已关闭或挂起的 VM。这样的逻辑端口没有位置且没有连接性。）

逻辑路由器端口 (LRP) 是进出逻辑路由器的连接点。LRP 将逻辑路由器连接到逻辑交换机或另一个逻辑路由器。逻辑路由器仅通过逻辑交换机间接连接到 VM、容器和其他网络节点。

逻辑交换机和逻辑路由器有不同种类的逻辑端口，所以严格来说，通常应该谈论逻辑交换机端口或逻辑路由器端口。但是，不加限定的“逻辑端口”通常指的是逻辑交换机端口。

当 VM 向 VIF 逻辑交换机端口发送数据包时，Open vSwitch 流表模拟数据包通过该逻辑交换机以及它可能遇到的任何其他逻辑路由器和逻辑交换机的旅程。这在不通过任何物理介质传输数据包的情况下发生：流表实现所有的交换和路由决策及行为。如果流表最终决定在连接到另一个管理程序（或另一种传输节点）的逻辑端口输出数据包，那么这就是为物理网络传输封装数据包并发送的时间。

### 逻辑交换机端口类型

OVN 支持多种逻辑交换机端口。连接到 VM 或容器的 VIF 端口（如上所述）是最普通的 LSP 类型。在 OVN 北向数据库中，VIF 端口的类型为空字符串。本节描述一些其他的端口类型。

*   `router` 逻辑交换机端口将逻辑交换机连接到逻辑路由器，指定特定的 LRP 作为其对等体。

*   `localnet` 逻辑交换机端口将逻辑交换机桥接到物理 VLAN。逻辑交换机可以有一个或多个 localnet 端口。这种逻辑交换机用于两种场景：

    *   具有一个或多个 `router` 逻辑交换机端口，用于将 L3 网关路由器和分布式网关连接到物理网络。

    *   具有一个或多个 VIF 逻辑交换机端口，用于将 VM 或容器直接连接到物理网络。在这种情况下，逻辑交换机并不是真正的逻辑交换机，因为它是桥接到物理网络而不是与其隔离，因此不能拥有独立但重叠的 IP 地址命名空间等。尽管如此，部署可能会选择这种配置以利用 OVN 控制平面和端口安全及 ACL 等功能。

当逻辑交换机包含多个 localnet 端口时，假设如下：

*   每个 Chassis 仅具有其中一个 localnet 物理网络的网桥映射。

*   为了促进位于不同 Chassis 上且具有不同物理网络连接的交换机 VIF 端口之间的互连，fabric 在这些相邻物理网络段之间实现 L3 路由。

注意：上面所说的并不意味着 Chassis 不能插入多个物理网络，只要它们属于不同的交换机。

*   `localport` 逻辑交换机端口是一种特殊的 VIF 逻辑交换机端口。这些端口存在于每个 Chassis 中，不绑定到任何特定的 Chassis。发往此类端口的流量永远不会通过隧道转发，并且预期从此类端口发出的流量仅发往同一 Chassis，通常是对其收到的请求的响应。OpenStack Neutron 使用 localport 端口为 VM 提供元数据。元数据代理进程在每台主机上连接到此端口，同一网络内的所有 VM 将在相同的 IP/MAC 地址访问它，而无需通过隧道发送任何流量。有关更多详细信息，请参阅 networking-ovn 的 OpenStack 文档。

LSP 类型 `vtep` 和 `l2gateway` 用于网关。有关更多信息，请参阅下面的“网关”。

### 实现细节

这些概念是 OVN 内部如何实现的细节。用户和管理员可能仍然对此感兴趣。

逻辑数据路径是 OVN 南向数据库中逻辑网络的实现细节。`ovn-northd` 将北向数据库中的每个逻辑交换机或路由器转换为南向数据库 `Datapath_Binding` 表中的逻辑数据路径。

在很大程度上，`ovn-northd` 还将 OVN 北向数据库中的每个逻辑交换机端口转换为南向数据库 `Port_Binding` 表中的记录。后一张表大致对应于北向 `Logical_Switch_Port` 表。它有多种类型的逻辑端口绑定，其中许多类型直接对应于北向 LSP 类型。以这种方式处理的 LSP 类型包括 VIF（空字符串）、`localnet`、`localport`、`vtep` 和 `l2gateway`。

`Port_Binding` 表有一些不直接对应于逻辑交换机端口类型的端口绑定类型。常见的是补丁端口绑定，称为逻辑补丁端口。这些端口绑定总是成对出现，进入一侧的数据包会从另一侧出来。`ovn-northd` 使用逻辑补丁端口将逻辑交换机和逻辑路由器连接在一起。

类型为 `vtep`、`l2gateway`、`l3gateway` 和 `chassisredirect` 的端口绑定用于网关。这些将在下面的“网关”中解释。
