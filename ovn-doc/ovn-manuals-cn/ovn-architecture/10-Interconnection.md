# OVN 部署互连

运营商部署多个 OVN 集群的情况并不罕见，主要原因有两个。首先，运营商可能更愿意为每个可用性区域（AZ）部署一个 OVN 集群，例如在不同的物理区域，以避免单点故障。其次，单个 OVN 控制平面的扩展总是存在上限。

虽然不同可用性区域 (AZ) 的控制平面彼此独立，但不同 AZ 的工作负载可能需要跨区域通信。OVN 互连功能提供了一种原生方式，通过不同 AZ 的逻辑路由器之间的中转覆盖网络进行 L3 路由来互连不同的 AZ。

引入了一个全局 OVN 互连北向数据库，供运营商（可能通过 CMS 系统）配置连接来自不同 AZ 的逻辑路由器/交换机的中转逻辑交换机/路由器。中转交换机类似于常规逻辑交换机，但它仅用于互连目的。通常，每个中转交换机可用于连接跨所有 AZ 属于同一租户的所有逻辑路由器。中转路由器类似于分布式路由器，另外还有一个好处是它可以跨 AZ 工作。

每个 AZ 中的专用守护进程 `ovn-ic`（OVN 互连控制器）将使用这些数据，并为每个 AZ 将相应的逻辑交换机/路由器填充到它们自己的北向数据库中。以便逻辑路由器可以通过在其北向数据库中创建补丁端口对来连接到中转交换机。连接到中转交换机的任何路由器端口都被视为互连端口，将在 AZ 之间交换。

在物理上，当来自不同 AZ 的工作负载进行通信时，数据包需要经过多跳：源 Chassis、源网关、目标网关和目标 Chassis。所有这些跳都通过隧道连接，以便数据包永远不会离开覆盖网络。需要一个分布式网关端口将逻辑路由器连接到中转交换机，并指定一个网关 Chassis，以便流量可以通过网关 Chassis 转发。

引入了一个全局 OVN 互连南向数据库，用于在 AZ 之间交换控制平面信息。该数据库中的数据由每个 AZ 的 `ovn-ic` 填充和使用。该数据库中的主要信息包括：

*   中转交换机的数据路径绑定，主要包含为每个中转交换机生成的隧道密钥。为中转交换机保留了单独的密钥范围，以便它们永远不会与每个 AZ 内为数据路径本地分配的任何隧道密钥冲突。

*   可用性区域，由每个 AZ 的 `ovn-ic` 注册。

*   网关。每个 AZ 指定应该作为互连网关工作的 Chassis，并且 `ovn-ic` 将此信息填充到互连南向数据库。来自所有其他 AZ 的 `ovn-ic` 将学习这些网关并作为 Chassis 填充到它们自己的南向数据库中。

*   在中转交换机上创建的逻辑交换机端口的端口绑定。每个 AZ 独立维护其逻辑路由器到中转交换机的连接，但 `ovn-ic` 会自动将中转交换机上的本地端口绑定填充到全局互连南向数据库，并将来自其他 AZ 的远程端口绑定学习回其自己的北向和南向数据库，以便可以在本地生成逻辑流，然后转换为 OVS 流，最终实现数据平面通信。

*   在不同 AZ 之间通告的路由。如果启用，路由将由 `ovn-ic` 自动交换。静态路由和直连子网都会被通告。OVN_NB 数据库的 `NB_Global` 表的 `options` 列中的选项控制路由通告的行为，例如启用/禁用通告/学习路由，是否通告/学习默认路由，以及列入黑名单的 CIDR。有关更多详细信息，请参阅 `ovn-nb(5)`。

中转交换机数据路径和相关端口绑定的隧道密钥必须在所有 AZ 之间达成一致。这是通过在全局互连南向数据库中生成和存储密钥来确保的。来自任何 AZ 的任何 `ovn-ic` 都可以分配密钥，但通过在数据库中强制执行列的唯一索引来解决竞争条件。

一旦每个 AZ 的 NB 和 SB 数据库填充了互连交换机和端口，并就隧道密钥达成一致，AZ 之间的数据平面通信就建立了。

当在 OVN 集群中启用 VXLAN 隧道时，由于 VNI 可用范围有限，不支持互连功能。

### 跨 AZ 数据包的一天

1.  IP 数据包从 AZ1 的管理程序 (HV1) 上的 VIF 发出，目标 IP 属于 AZ2 中的 VIF。

2.  在 HV1 的 OVS 流表中，数据包经过逻辑交换机和逻辑路由器管道，在逻辑路由器管道中，路由阶段找出目标 IP 的下一跳，它属于 AZ2 中的远程逻辑路由器端口，以及输出端口，它是位于互连网关 (AZ1 中的 GW1) 上的 chassis-redirect 端口，因此 HV1 通过隧道将数据包发送到 GW1。

3.  在 GW1 上，它继续逻辑路由器管道并通过 chassis-redirect 端口的对等端口切换到中转交换机的管道。在中转交换机的管道中，它输出到位于 AZ2 中网关 (GW2) 上的远程逻辑端口，因此 GW1 在隧道中将数据包发送到 GW2。

4.  在 GW2 上，它继续中转交换机管道并通过对等端口切换到逻辑路由器管道，该对等端口是位于 GW2 上的 chassis-redirect 端口。然后逻辑路由器管道根据目标 IP 地址将数据包转发到相关的逻辑管道，并找出目标 VIF 端口的 MAC 和位置 - 管理程序 (HV2)。GW2 然后在隧道中将数据包发送到 HV2。

5.  在 HV2 上，数据包通过逻辑交换机出口管道传递到最终目标 VIF 端口，就像 AZ 内通信一样。
