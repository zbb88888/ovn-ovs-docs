# 网关

网关提供逻辑网络和物理网络之间有限的连接。它们还可以提供不同 OVN 部署之间的连接。本节将重点介绍前者，后者将在“OVN 部署互连”一节中详细描述。

OVN 支持多种网关。

### VTEP 网关

“VTEP 网关”将 OVN 逻辑网络连接到实现 Open vSwitch 附带的 OVSDB VTEP 模式的物理（或虚拟）交换机。（“VTEP 网关”这个术语用词不当，因为 VTEP 只是一个 VXLAN 隧道端点，但它是一个完善的名称。）有关更多信息，请参阅下面的“VTEP 网关的生命周期”。

VTEP 网关的主要预期用例是使用支持 OVSDB VTEP 模式的物理架顶式交换机将物理服务器连接到 OVN 逻辑网络。

### L2 网关

L2 网关简单地将某个 Chassis 上可用的指定物理 L2 网段连接到逻辑网络。物理网络有效地成为逻辑网络的一部分。

要设置 L2 网关，CMS 将 `l2gateway` LSP 添加到适当的逻辑交换机，设置 LSP 选项以命名应绑定到的 Chassis。`ovn-northd` 将此配置复制到南向 `Port_Binding` 记录中。在指定的 Chassis 上，`ovn-controller` 适当地向物理网段转发数据包或从物理网段接收数据包。

L2 网关端口具有与 `localnet` 端口共同的功能。但是，对于 `localnet` 端口，物理网络成为管理程序之间的传输。对于 L2 网关，数据包仍然通过隧道在管理程序之间传输，并且 `l2gateway` 端口仅用于物理网络上的数据包。L2 网关的应用类似于 VTEP 网关，例如将非虚拟化机器添加到逻辑网络，但 L2 网关不需要来自架顶式硬件交换机的特殊支持。

### L3 网关路由器

如上文“逻辑网络”中所述，普通的 OVN 逻辑路由器是分布式的：它们不是在单个位置实现的，而是在每个管理程序 Chassis 中实现的。这对于 SNAT 和 DNAT 等有状态服务来说是一个问题，因为它们需要以集中方式实现。

为了允许这种功能，OVN 支持 L3 网关路由器，这是在指定 Chassis 中实现的 OVN 逻辑路由器。网关路由器通常用于分布式逻辑路由器和物理网络之间。分布式逻辑路由器及其后面的逻辑交换机（VM 和容器连接到该交换机）实际上驻留在每个管理程序上。分布式路由器和网关路由器通过另一个逻辑交换机连接，有时称为“连接”逻辑交换机。（OVN 逻辑路由器可以直接相互连接，无需中间交换机，但 OVN 实现仅支持连接到逻辑交换机的网关逻辑路由器。使用连接逻辑交换机还可以减少分布式路由器所需的 IP 地址数量。）在另一侧，网关路由器连接到另一个具有连接到物理网络的 `localnet` 端口的逻辑交换机。

下图显示了一个典型情况。一个或多个逻辑交换机 LS1, ..., LSn 连接到分布式逻辑路由器 LR1，LR1 依次通过 LSjoin 连接到网关逻辑路由器 GLR，GLR 也连接到包含连接到物理网络的 `localnet` 端口的逻辑交换机 LSlocal。

```text
                                LSlocal
                                   |
                                  GLR
                                   |
                                LSjoin
                                   |
                                  LR1
                                   |
                              +----+----+
                              |    |    |
                             LS1  ...  LSn
```

要配置 L3 网关路由器，CMS 将路由器北向 `Logical_Router` 中的 `options:chassis` 设置为 Chassis 的名称。作为响应，`ovn-northd` 在南向数据库中使用特殊的 `l3gateway` 端口绑定（而不是补丁绑定）将逻辑路由器连接到其邻居。反过来，`ovn-controller` 将数据包通过隧道传输到指定的 L3 网关 Chassis 上的此端口绑定，而不是在本地处理它们。

DNAT 和 SNAT 规则可以与网关路由器关联，这提供了一个可以处理一对多 SNAT（也称为 IP 伪装）的中心位置。下面描述的分布式网关端口也支持 NAT。

### 分布式网关端口

分布式网关端口是一种逻辑路由器端口，经过专门配置以指定一个独特的 Chassis（称为网关 Chassis）进行集中处理。分布式网关端口应连接到具有外部连接 LSP 的逻辑交换机，即 `localnet` LSP 或连接到另一个 OVN 部署的连接（请参阅 OVN 部署互连）。穿过分布式网关端口的数据包在可能的情况下不涉及网关 Chassis 进行处理，但在需要时确实会经过它进行额外的跳转。

下图说明了分布式网关端口的使用。许多逻辑交换机 LS1, ..., LSn 连接到分布式逻辑路由器 LR1，LR1 依次通过分布式网关端口连接到包含连接到物理网络的 `localnet` 端口的逻辑交换机 LSlocal。

```text
                                LSlocal
                                   |
                                  LR1
                                   |
                              +----+----+
                              |    |    |
                             LS1  ...  LSn
```

`ovn-northd` 创建两个南向 `Port_Binding` 记录来表示分布式网关端口，而不是通常的一个。其中一个是名为 LRP 的补丁端口绑定，用于尽可能多的流量。另一个是类型为 `chassisredirect` 的端口绑定，名为 cr-port。`chassisredirect` 端口绑定有一个专门的工作：当数据包输出到它时，流表会导致它被隧道传输到网关 Chassis，此时它会自动输出到补丁端口绑定。因此，在特定任务必须在网关 Chassis 上发生的情况下，流表可以输出到此端口绑定。`chassisredirect` 端口绑定在其他方面不被使用（例如，它从不接收数据包）。

CMS 可以通过三种不同的方式配置分布式网关端口。有关详细信息，请参阅 `ovn-nb(5)` 中 `Logical_Router_Port` 文档中的分布式网关端口。

分布式网关端口支持高可用性。当指定多个 Chassis 时，OVN 一次仅使用一个作为网关 Chassis。OVN 使用 BFD 监控网关连接性，优先选择在线的最高优先级网关。

逻辑路由器可以有多个分布式网关端口，每个连接不同的外部网络。对于配置了多个分布式网关端口的逻辑路由器，尚不支持负载均衡。

#### 物理 VLAN MTU 问题

再次考虑前面的图：

```text
                                LSlocal
                                   |
                                  LR1
                                   |
                              +----+----+
                              |    |    |
                             LS1  ...  LSn
```

假设每个逻辑交换机 LS1, ..., LSn 通过 LR1 上的分布式网关端口桥接到连接到 LSlocal 上 `localnet` 端口的物理 VLAN 标记网络。如果源自 LSi 的数据包发往外部网络，OVN 会通过隧道将其发送到网关 Chassis。在那里，数据包遍历 LR1 的逻辑路由器管道，可能经历 NAT，最终到达 LSlocal 的 `localnet` 端口。如果网络中的所有物理链路都具有相同的 MTU，则数据包穿越隧道会导致 MTU 问题：隧道开销阻止使用完整物理 MTU 的数据包穿过隧道到达网关 Chassis（在不分片的情况下）。

OVN 针对此问题提供了两种解决方案：`reside-on-redirect-chassis` 和 `redirect-type` 选项。这两种解决方案都要求每个逻辑交换机 LS1, ..., LSn 分别包含一个存在于每个 Chassis 上的 `localnet` 逻辑交换机端口 LN1, ..., LNn。两者都会导致数据包通过 `localnet` 端口而不是隧道发送。它们的区别在于哪些数据包（部分或全部）以这种方式发送。这些选项之间最显著的权衡是 `reside-on-redirect-chassis` 更易于配置，而 `redirect-type` 对东西向流量的性能更好。

第一个解决方案是逻辑路由器端口的 `reside-on-redirect-chassis` 选项。在从（例如）LS1 到 LR1 的 LRP 上设置此选项会禁用从 LS1 到 LR1 的转发，除非在网关 Chassis 上。在除网关 Chassis 之外的 Chassis 上，这单一更改意味着原本会转发到 LR1 的数据包将改为转发到 LN1。网关 Chassis 上的 LN1 实例随后接收数据包并将其转发到 LR1。数据包遍历 LR1 逻辑路由器管道，可能经历 NAT，最终到达 LSlocal 的 `localnet` 端口。数据包从不遍历隧道，从而避免了 MTU 问题。

此选项的进一步后果是集中化“分布式”逻辑路由器 LR1，因为除了网关 Chassis 之外，没有任何数据包在任何 Chassis 上从 LS1 转发到 LR1。因此，东西向流量通过网关 Chassis，而不仅仅是南北向流量。（允许东西向流量通过 LN1 直接在 Chassis 之间流动的简单“修复”不起作用，因为路由将以太网源地址设置为 LR1 的源地址。看到这单一以太网源地址源自所有 Chassis 会混淆物理交换机。）

不要在分布式网关端口上设置 `reside-on-redirect-chassis` 选项。在上图中，它将设置在连接 LS1, ..., LSn 到 LR1 的 LRP 上。

第二个解决方案是分布式网关端口的 `redirect-type` 选项。将此选项设置为 `bridged` 会导致重定向到网关 Chassis 的数据包通过 `localnet` 端口而不是被隧道传输。此选项不会改变 OVN 如何处理未重定向到网关 Chassis 的数据包。

`redirect-type` 选项要求管理员或 CMS 通过在 Open vSwitch 数据库中设置 `ovn-chassis-mac-mappings` 为每个参与的 Chassis 配置逻辑路由器的唯一以太网地址，供 `ovn-controller` 使用。这使得它比 `reside-on-redirect-chassis` 更难配置。

在分布式网关端口上设置 `redirect-type` 选项。

#### 使用分布式网关端口实现可扩展性

尽管分布式网关端口的主要目标是提供与外部网络的连接，但还有一个用于可扩展性的特殊用例。

在某些部署中，例如使用 `ovn-kubernetes` 的部署，逻辑交换机绑定到单个 Chassis，并通过分布式逻辑路由器连接。在这类部署中，Chassis 级别的逻辑交换机集中在 Chassis 上而不是分布式的，这意味着每个 Chassis 上的 `ovn-controller` 不需要处理其他 Chassis 上逻辑交换机的流和端口。但是，没有任何特定提示，`ovn-controller` 仍会将所有逻辑交换机视为完全分布式的来处理。在这种情况下，分布式网关端口非常有用。可以通过将网关 Chassis（或其中仅包含单个 Chassis 的 HA Chassis 组）设置为每个逻辑交换机绑定的 Chassis，使用分布式网关端口将 Chassis 级别的逻辑交换机连接到分布式路由器。然后，`ovn-controller` 将跳过处理所有其他 Chassis 上的逻辑交换机，从而大大提高可扩展性，尤其是在有大量 Chassis 时。
