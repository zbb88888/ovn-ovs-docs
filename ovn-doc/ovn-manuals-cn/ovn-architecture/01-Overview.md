# OVN 架构

## 名称
ovn-architecture - 开放虚拟网络 (Open Virtual Network) 架构

## 描述

OVN（Open Virtual Network，开放虚拟网络）是一个支持虚拟机和容器环境中逻辑网络抽象的系统。OVN 补充了 OVS 的现有功能，增加了对逻辑网络抽象的原生支持，例如逻辑 L2 和 L3 覆盖网络以及安全组。DHCP 等服务也是所需的功能。就像 OVS 一样，OVN 的设计目标是拥有一个可在大规模环境下运行的生产级实现。

物理网络由物理线路、交换机和路由器组成。虚拟网络将物理网络扩展到管理程序或容器平台，将 VM 或容器桥接到物理网络。OVN 逻辑网络是在软件中实现的网络，通过隧道或其他封装与物理（以及因此的虚拟）网络隔离。这允许逻辑网络中使用的 IP 和其他地址空间与物理网络上使用的地址空间重叠而不会引起冲突。逻辑网络拓扑可以不考虑其运行所在的物理网络的拓扑进行安排。因此，属于逻辑网络一部分的 VM 可以从一台物理机迁移到另一台物理机，而不会中断网络。有关更多信息，请参阅下面的“逻辑网络”部分。

封装层阻止连接到逻辑网络的 VM 和容器与物理网络上的节点通信。对于集群 VM 和容器，这可能是可以接受的甚至也是可取的，但在许多情况下，VM 和容器确实需要连接到物理网络。OVN 为此目的提供了多种形式的网关。有关更多信息，请参阅下面的“网关”部分。

OVN 部署由几个组件组成：

*   云管理系统 (CMS)，它是 OVN 的最终客户端（通过其用户和管理员）。OVN 集成需要安装特定于 CMS 的插件和相关软件（见下文）。OVN 最初将 OpenStack 作为 CMS 目标。

    我们通常谈论“该”CMS，但可以想象多个 CMS 管理 OVN 部署的不同部分的场景。

*   安装在中心位置的 OVN 数据库物理或虚拟节点（或最终是集群）。

*   一个或多个（通常很多）管理程序。管理程序必须运行 Open vSwitch 并实现 Open vSwitch 源代码树中 `Documentation/topics/integration.rst` 中描述的接口。任何 Open vSwitch 支持的管理程序平台都是可以接受的。

*   零个或多个网关。网关通过在隧道和物理以太网端口之间双向转发数据包，将基于隧道的逻辑网络扩展到物理网络。这允许非虚拟化机器参与逻辑网络。网关可以是物理主机、虚拟机或支持 `vtep(5)` 模式的基于 ASIC 的硬件交换机。

    管理程序和网关统称为传输节点或 Chassis。

下图显示了 OVN 的主要组件和相关软件如何交互。从图的顶部开始，我们有：

*   云管理系统，如上定义。

*   OVN/CMS 插件是 CMS 中与 OVN 接口的组件。在 OpenStack 中，这是一个 Neutron 插件。该插件的主要目的是将 CMS 的逻辑网络配置概念（以 CMS 特定格式存储在 CMS 配置数据库中）转换为 OVN 理解的中间表示。

    此组件必然是特定于 CMS 的，因此需要为与 OVN 集成的每个 CMS 开发新插件。图中此组件下方的所有组件都是独立于 CMS 的。

*   OVN 北向数据库接收由 OVN/CMS 插件向下传递的逻辑网络配置的中间表示。数据库模式旨在与 CMS 中使用的概念“阻抗匹配”，以便它直接支持逻辑交换机、路由器、ACL 等概念。有关详细信息，请参阅 `ovn-nb(5)`。

    OVN 北向数据库只有两个客户端：其上方的 OVN/CMS 插件和其下方的 `ovn-northd`。

*   `ovn-northd(8)` 连接到其上方的 OVN 北向数据库和其下方的 OVN 南向数据库。它将从 OVN 北向数据库获取的传统网络概念方面的逻辑网络配置转换为其下方 OVN 南向数据库中的逻辑数据路径流。

*   OVN 南向数据库是系统的中心。其客户端是其上方的 `ovn-northd(8)` 和其下方每个传输节点上的 `ovn-controller(8)`。

    OVN 南向数据库包含三种数据：指定如何到达管理程序和其他节点的物理网络 (PN) 表，根据“逻辑数据路径流”描述逻辑网络的逻辑网络 (LN) 表，以及将逻辑网络组件的位置链接到物理网络的绑定表。管理程序填充 PN 和 `Port_Binding` 表，而 `ovn-northd(8)` 填充 LN 表。

    OVN 南向数据库性能必须随传输节点数量扩展。随着我们遇到瓶颈，这可能需要对 `ovsdb-server(1)` 进行一些工作。可能需要集群以实现可用性。

其余组件复制到每个管理程序上：

*   `ovn-controller(8)` 是每个管理程序和软件网关上的 OVN 代理。北向，它连接到 OVN 南向数据库以了解 OVN 配置和状态，并使用管理程序的状态填充 PN 表和绑定表中的 Chassis 列。南向，它作为 OpenFlow 控制器连接到 `ovs-vswitchd(8)` 以控制网络流量，并连接到本地 `ovsdb-server(1)` 以允许其监视和控制 Open vSwitch 配置。

*   `ovs-vswitchd(8)` 和 `ovsdb-server(1)` 是 Open vSwitch 的常规组件。

```text
                                  CMS
                                   |
                                   |
                       +-----------|-----------+
                       |           |           |
                       |     OVN/CMS Plugin    |
                       |           |           |
                       |           |           |
                       |   OVN Northbound DB   |
                       |           |           |
                       |           |           |
                       |       ovn-northd      |
                       |           |           |
                       +-----------|-----------+
                                   |
                                   |
                         +-------------------+
                         | OVN Southbound DB |
                         +-------------------+
                                   |
                                   |
                +------------------+------------------+
                |                  |                  |
  HV 1          |                  |    HV n          |
+---------------|---------------+  .  +---------------|---------------+
|               |               |  .  |               |               |
|        ovn-controller         |  .  |        ovn-controller         |
|         |          |          |  .  |         |          |          |
|         |          |          |     |         |          |          |
|  ovs-vswitchd   ovsdb-server  |     |  ovs-vswitchd   ovsdb-server  |
|                               |     |                               |
+-------------------------------+     +-------------------------------+
```

### OVN 中的信息流

OVN 中的配置数据从北向南流动。CMS 通过其 OVN/CMS 插件将逻辑网络配置通过北向数据库传递给 `ovn-northd`。反过来，`ovn-northd` 将配置编译为更低级的形式，并通过南向数据库将其传递给所有 Chassis。

OVN 中的状态信息从南向北流动。OVN 目前仅提供几种形式的状态信息。首先，`ovn-northd` 填充北向 `Logical_Switch_Port` 表中的 `up` 列：如果南向 `Port_Binding` 表中逻辑端口的 `chassis` 列非空，它将 `up` 设置为 true，否则为 false。这允许 CMS 检测 VM 的网络何时启动。

其次，OVN 向 CMS 提供有关其配置实现的反馈，即 CMS 提供的配置是否已生效。此功能要求 CMS 参与序列号协议，该协议的工作方式如下：

1.  当 CMS 更新北向数据库中的配置时，作为同一事务的一部分，它会递增 `NB_Global` 表中 `nb_cfg` 列的值。（仅当 CMS 想要知道配置何时实现时才需要这样做。）

2.  当 `ovn-northd` 根据北向数据库的给定快照更新南向数据库时，作为同一事务的一部分，它将 `nb_cfg` 从北向 `NB_Global` 复制到南向数据库 `SB_Global` 表。（因此，监视两个数据库的观察者可以确定南向数据库何时赶上北向数据库。）

3.  在 `ovn-northd` 从南向数据库服务器收到其更改已提交的确认后，它将北向 `NB_Global` 表中的 `sb_cfg` 更新为下推的 `nb_cfg` 版本。（因此，CMS 或其他观察者可以在不连接到南向数据库的情况下确定南向数据库何时赶上。）

4.  每个 Chassis 上的 `ovn-controller` 进程接收更新的南向数据库，其中包含更新的 `nb_cfg`。此进程反过来更新安装在 Chassis 的 Open vSwitch 实例中的物理流。当它从 Open vSwitch 收到物理流已更新的确认时，它会更新南向数据库中其自己的 `Chassis_Private` 记录中的 `nb_cfg`。（OVN v20.09.0 之前的版本使用 `Chassis` 表中的 `nb_cfg` 列。虽然此列仍然存在，但已弃用，转而使用 `Chassis_Private` 中的同一列，并且不再更新。）

5.  `ovn-northd` 监视南向数据库中所有 `Chassis_Private` 记录中的 `nb_cfg` 列。它跟踪所有记录中的最小值，并将其复制到北向 `NB_Global` 表中的 `hv_cfg` 列。（因此，CMS 或其他观察者可以确定所有管理程序何时赶上北向配置。）
