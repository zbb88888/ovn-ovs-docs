# 逻辑路由器和逻辑补丁端口

通常，逻辑路由器和逻辑补丁端口没有物理位置，实际上驻留在每个管理程序上。位于逻辑路由器和这些逻辑路由器后面的逻辑交换机（VM 和 VIF 连接到这些逻辑交换机）之间的逻辑补丁端口就是这种情况。

考虑从一个虚拟机或容器发送到驻留在不同子网上的另一个 VM 或容器的数据包。数据包将按照上一节“数据包的架构物理生命周期”中所述遍历表 0 到 65，使用代表发送方连接到的逻辑交换机的逻辑数据路径。在表 42 处，数据包将使用重新提交到同一管理程序上的表 43 的回退流。在这种情况下，从表 0 到表 65 的所有处理都发生在发送方驻留的管理程序上。

当数据包到达表 65 时，逻辑出口端口是一个逻辑补丁端口。`ovn-controller` 通过克隆并直接重新提交到入口管道中的第一个 OpenFlow 流表，将逻辑入口端口设置为对等逻辑补丁端口，并使用对等逻辑补丁端口的逻辑数据路径（代表逻辑路由器），来实现对逻辑补丁数据包的输出。

数据包重新进入入口管道以便再次遍历表 8 到 65，这次使用代表逻辑路由器的逻辑数据路径。处理继续如上一节“数据包的架构物理生命周期”中所述。当数据包到达表 65 时，逻辑出口端口将再次是逻辑补丁端口。以与上述相同的方式，此逻辑补丁端口将导致数据包重新提交到 OpenFlow 表 8 到 65，这次使用代表目标 VM 或容器连接到的逻辑交换机的逻辑数据路径。

数据包第三次也是最后一次遍历表 8 到 65。如果目标 VM 或容器驻留在远程管理程序上，则表 39 将在隧道端口上将数据包从发送方的管理程序发送到远程管理程序。最后，表 65 将把数据包直接输出到目标 VM 或容器。

以下部分描述了两个例外，其中逻辑路由器和/或逻辑补丁端口与物理位置相关联。

### 网关路由器

网关路由器是绑定到物理位置的逻辑路由器。这包括逻辑路由器的所有逻辑补丁端口，以及逻辑交换机上的所有对等逻辑补丁端口。在 OVN 南向数据库中，这些逻辑补丁端口的 `Port_Binding` 条目使用类型 `l3gateway` 而不是 `patch`，以区分这些逻辑补丁端口绑定到 Chassis。

当管理程序处理代表逻辑交换机的逻辑数据路径上的数据包，并且逻辑出口端口是代表到网关路由器的连接的 `l3gateway` 端口时，数据包将匹配表 42 中的流，该流将数据包在隧道端口上发送到网关路由器所在的 Chassis。表 42 中的此处理以与 VIF 相同的方式完成。

### 分布式网关端口

本节提供前面概述的分布式网关端口的更多详细信息。

分布式网关端口的主要设计目标是允许尽可能多的流量在 VM 或容器驻留的管理程序上本地处理。只要可能，从 VM 或容器到外部世界的数据包应在该 VM 或容器的管理程序上完全处理，最终通过 `localnet` 端口实例或隧道传输到物理网络或不同的 OVN 部署。只要可能，从外部世界到 VM 或容器的数据包应通过物理网络直接定向到 VM 或容器的管理程序。

为了允许上述段落中描述的数据包的分布式处理，分布式网关端口需要是实际上驻留在每个管理程序上的逻辑补丁端口，而不是绑定到特定 Chassis 的 `l3gateway` 端口。但是，与分布式网关端口关联的流通常需要与物理位置关联，原因如下：

*   `localnet` 端口连接到的物理网络通常使用 L2 学习。通过分布式网关端口使用的任何以太网地址必须限制在单个物理位置，以便上游 L2 学习不会混淆。通过分布式网关端口向具有特定以太网地址的 `localnet` 端口发出的流量必须在一个特定 Chassis 上的一个特定分布式网关端口实例发出。从具有特定以太网地址的 `localnet` 端口（或从与 `localnet` 端口位于同一逻辑交换机上的 VIF）接收的流量必须定向到该特定 Chassis 上的逻辑交换机的补丁端口实例。

    由于 L2 学习的影响，分布式网关端口的以太网地址和 IP 地址需要限制在单个物理位置。因此，用户必须指定一个与分布式网关端口关联的 Chassis。请注意，使用其他以太网地址和 IP 地址（例如一对一 NAT）穿越分布式网关端口的流量不受此 Chassis 的限制。

    对 ARP 和 ND 请求的回复必须限制在单个物理位置，即回复中的以太网地址所在的位置。这包括对分布式网关端口 IP 地址的 ARP 和 ND 回复，这些回复限制在用户与分布式网关端口关联的 Chassis 上。

*   为了支持一对多 SNAT（也称为 IP 伪装），其中分布在多个 Chassis 上的多个逻辑 IP 地址映射到单个外部 IP 地址，有必要以集中方式在特定 Chassis 上处理某些逻辑路由器处理。由于 SNAT 外部 IP 地址通常是分布式网关端口 IP 地址，为简单起见，使用与分布式网关端口关联的同一 Chassis。

流向特定 Chassis 的流限制的详细信息在 `ovn-northd` 文档中描述。

虽然分布式网关端口的大多数依赖于物理位置的方面可以通过将某些流限制到特定 Chassis 来处理，但也需要一种额外的机制。当数据包离开入口管道且逻辑出口端口是分布式网关端口时，表 42 需要两组不同的操作之一：

*   如果数据包可以在发送方的管理程序上本地处理（例如一对一 NAT 流量），则数据包应像分布式逻辑补丁端口的正常方式一样，在本地重新提交到表 43。

*   但是，如果数据包需要在与分布式网关端口关联的 Chassis 上处理（例如一对多 SNAT 流量或非 NAT 流量），则表 42 必须将数据包在隧道端口上发送到该 Chassis。

为了触发第二组操作，添加了南向 `Port_Binding` 的 `chassisredirect` 类型。将逻辑出口端口设置为 `chassisredirect` 类型逻辑端口只是指示虽然数据包发往分布式网关端口，但需要将其重定向到不同的 Chassis 的一种方式。在表 42 处，具有此逻辑出口端口的数据包被发送到特定 Chassis，方式与表 42 将逻辑出口端口为 VIF 或 `l3gateway` 类型端口的数据包定向到不同 Chassis 的方式相同。一旦数据包到达该 Chassis，表 43 将逻辑出口端口重置为代表分布式网关端口的值。对于每个分布式网关端口，除了代表分布式网关端口的分布式逻辑补丁端口外，还有一个 `chassisredirect` 类型端口。

#### 分布式网关端口的高可用性

OVN 允许您为分布式网关端口指定优先级的 Chassis 列表。这是通过在 OVN_Northbound 数据库中将多个 `Gateway_Chassis` 行与 `Logical_Router_Port` 关联来完成的。

当为网关指定了多个 Chassis 时，所有可能向该网关发送数据包的 Chassis 将在到所有配置的网关 Chassis 的隧道上启用 BFD。网关的当前活动 Chassis 是当前基于 BFD 状态被视为活动的最高优先级网关 Chassis。

有关 L3 网关高可用性的更多信息，请参阅 `http://docs.ovn.org/en/latest/topics/high-availability.html`。

#### 分布式网关端口的限制

分布式网关端口用于连接到外部网络，该网络可以是通​​过具有 `localnet` 端口的逻辑交换机建模的物理网络，也可以是互连不同 OVN 部署的逻辑交换机（请参阅 OVN 部署互连）。通常可以有许多逻辑路由器连接到同一个外部逻辑交换机，如下图所示。

```text
                              +--LS-EXT-+
                              |    |    |
                              |    |    |
                             LR1  ...  LRn
```

在此图中，有 n 个逻辑路由器连接到逻辑交换机 LS-EXT，每个都有一个分布式网关端口，以便发送到外部世界的流量被重定向到分配给相应逻辑路由器的分布式网关端口的网关 Chassis。

在逻辑拓扑中，没有什么可以阻止用户通过 LS-EXT 上连接的分布式网关端口在逻辑路由器之间添加路由。但是，该路由仅在 LS-EXT 是物理网络（通过具有 `localnet` 端口的逻辑交换机建模）时才有效。在这种情况下，数据包将通过物理网络经由 `localnet` 端口在网关 Chassis 之间传递。如果 LS-EXT 是常规逻辑交换机（仅由隧道支持，如在 OVN 互连用例中），则数据包将在源网关 Chassis 上被丢弃。该限制是由于分布式网关端口绑定到物理位置，如果没有物理网络连接，我们将最终丢弃数据包或通过隧道传输它，这可能会导致更大的问题，例如广播数据包被不同的网关 Chassis 重复重定向。

考虑到这一限制，如果用户确实希望逻辑路由器之间直接连接，最好创建一个内部逻辑交换机，通过常规逻辑路由器端口连接到逻辑路由器，这些端口完全分布，数据包除非必要不必离开 Chassis，这比通过分布式网关端口路由更优。

#### ARP 请求和 ND NS 数据包处理

由于 ARP 请求和 ND NA 数据包通常是广播数据包，出于性能原因，OVN 以特定方式处理针对 OVN 拥有 IP 地址（即在路由器端口、VIP、NAT IP 上配置的 IP 地址）的请求，并仅将其转发到拥有目标 IP 地址的逻辑路由器。此行为与传统交换机不同，这意味着连接到逻辑交换机的其他路由器/主机将不会从请求数据包中学习 MAC/IP 绑定。

所有其他 ARP 和 ND 数据包都在 L2 广播域和所有附加的逻辑补丁端口中泛洪。

#### 通过分布式网关端口连接的逻辑交换机上的 VIF

通常，通过分布式网关端口连接的逻辑交换机用于外部连接，通常通过逻辑交换机上的 `localnet` 端口连接到物理网络，或通过 OVN 互连连接到远程 OVN 部署。在这些情况下，逻辑交换机上不需要 VIF 端口。

虽然不是很常见，但仍然可以在通过分布式网关端口连接的逻辑交换机上创建 VIF 端口，但有一个限制，即逻辑端口需要驻留在分布式网关端口所在的网关 Chassis 上，以便通过分布式网关端口连接到其他逻辑交换机。VIF 在逻辑交换机内连接或通过其他常规分布式逻辑路由器端口超出逻辑交换机连接没有限制。

一种特殊情况是如本文前面所述使用分布式网关端口进行可扩展性目的。通过分布式网关端口连接的逻辑交换机不是为了连接性，而只是为了常规 VIF。但是，上述限制通常无关紧要，因为在此用例中，逻辑交换机上的所有 VIF 都与连接逻辑交换机的分布式网关端口位于同一 Chassis 上。

### 连接到逻辑路由器的多个 localnet 逻辑交换机

可以有多个逻辑交换机（每个都带有代表物理网络的 `localnet` 端口）连接到一个逻辑路由器，其中一个 `localnet` 逻辑交换机可以通过分布式网关端口提供外部连接，其余的 `localnet` 逻辑交换机在物理网络中使用 VLAN 标记。预期在 Chassis 上为所有这些 `localnet` 网络适当地配置了 `ovn-bridge-mappings`。

#### 东西向路由

这些 `localnet` VLAN 标记逻辑交换机之间的东西向路由的工作方式几乎与普通逻辑交换机相同。当 VM 发送此类数据包时：

1.  它首先进入入口管道，然后进入源 `localnet` 逻辑交换机数据路径的出口管道。然后它通过源 Chassis 中的逻辑路由器端口进入逻辑路由器数据路径的入口管道。

2.  做出路由决策。

3.  从路由器数据路径，数据包进入入口管道，然后进入目标 `localnet` 逻辑交换机数据路径的出口管道，并通过 `localnet` 端口从集成网桥出去到提供商网桥（属于目标逻辑交换机）。在向提供商网桥发送数据包时，我们还将路由器端口 MAC 作为源 MAC 替换为 Chassis 唯一 MAC。

    此 Chassis 唯一 MAC 在每个 Chassis 上配置为全局 ovs 配置（例如通过 `ovs-vsctl set open . external-ids:ovn-chassis-mac-mappings="phys:aa:bb:cc:dd:ee:$i$i"`）。有关更多详细信息，请参阅 `ovn-controller(8)`。

    如果未配置上述内容，则源 MAC 将是路由器端口 MAC。如果我们有多个 Chassis，这可能会产生问题。这是因为，由于路由器端口是分布式的，物理网络也会从其他 Chassis 看到相同的 (MAC, VLAN) 元组，这可能会导致这些问题：

    *   架顶式交换机 (ToR) 中的连续 MAC 移动。

    *   ToR 丢弃流量，这导致连续的 MAC 移动。

    *   ToR 阻塞发生 MAC 移动的端口。

4.  目标 Chassis 通过 `localnet` 端口接收数据包并将其发送到集成网桥。在进入集成网桥之前，数据包的源 mac 将再次替换为路由器端口 mac。数据包进入入口管道，然后进入目标 `localnet` 逻辑交换机的出口管道，最后传递到目标 VM 端口。

#### 外部流量

当 VM 发送外部流量（需要 NAT）且托管 VM 的 Chassis 没有分布式网关端口时，会发生以下情况。

1.  数据包首先进入入口管道，然后进入源 `localnet` 逻辑交换机数据路径的出口管道。然后它通过源 Chassis 中的逻辑路由器端口进入逻辑路由器数据路径的入口管道。

2.  做出路由决策。由于网关路由器或分布式网关端口不驻留在源 Chassis 中，流量通过隧道端口重定向到网关 Chassis。

3.  网关 Chassis 通过隧道端口接收数据包，数据包进入逻辑路由器数据路径的出口管道。NAT 规则在此应用。然后数据包进入入口管道，然后进入提供外部连接的 `localnet` 逻辑交换机数据路径的出口管道，最后通过提供外部连接的逻辑交换机的 `localnet` 端口出去。

尽管这有效，但 VM 流量在从计算 Chassis 发送到网关 Chassis 时是通过隧道传输的。为了使其正常工作，必须降低 `localnet` 逻辑交换机的 MTU 以考虑隧道封装。

### 连接到逻辑路由器的 localnet VLAN 标记逻辑交换机的集中路由

为了克服上一节中描述的隧道封装问题，OVN 支持为 `localnet` VLAN 标记逻辑交换机启用集中路由的选项。CMS 可以为每个连接到 `localnet` VLAN 标记逻辑交换机的 `Logical_Router_Port` 将选项 `options:reside-on-redirect-chassis` 配置为 true。这会导致网关 Chassis（托管分布式网关端口）处理这些网络的所有路由，使其集中化。它将回复逻辑路由器端口 IP 的 ARP 请求。

如果逻辑路由器没有连接到提供外部连接的 `localnet` 逻辑交换机的分布式网关端口，或者如果它有多个分布式网关端口，则 OVN 会忽略此选项。

当 VM 发送需要路由的东西向流量时，会发生以下情况：

1.  数据包首先进入入口管道，然后进入源 `localnet` 逻辑交换机数据路径的出口管道，并通过源 `localnet` 逻辑交换机的 `localnet` 端口发出（而不是将其发送到路由器管道）。

2.  网关 Chassis 通过源 `localnet` 逻辑交换机的 `localnet` 端口接收数据包并将其发送到集成网桥。然后数据包进入入口管道，然后进入源 `localnet` 逻辑交换机数据路径的出口管道，并进入逻辑路由器数据路径的入口管道。

3.  做出路由决策。

4.  从路由器数据路径，数据包进入入口管道，然后进入目标 `localnet` 逻辑交换机数据路径的出口管道。然后它通过 `localnet` 端口从集成网桥出去到提供商网桥（属于目标逻辑交换机）。

5.  目标 Chassis 通过 `localnet` 端口接收数据包并将其发送到集成网桥。数据包进入入口管道，然后进入目标 `localnet` 逻辑交换机的出口管道，最后传递到目标 VM 端口。

当 VM 发送需要 NAT 的外部流量时，会发生以下情况：

1.  数据包首先进入入口管道，然后进入源 `localnet` 逻辑交换机数据路径的出口管道，并通过源 `localnet` 逻辑交换机的 `localnet` 端口发出（而不是将其发送到路由器管道）。

2.  网关 Chassis 通过源 `localnet` 逻辑交换机的 `localnet` 端口接收数据包并将其发送到集成网桥。然后数据包进入入口管道，然后进入源 `localnet` 逻辑交换机数据路径的出口管道，并进入逻辑路由器数据路径的入口管道。

3.  做出路由决策并应用 NAT 规则。

4.  从路由器数据路径，数据包进入入口管道，然后进入提供外部连接的 `localnet` 逻辑交换机数据路径的出口管道。然后它通过 `localnet` 端口从集成网桥出去到提供商网桥（属于提供外部连接的逻辑交换机）。

对于反向外部流量，会发生以下情况。

1.  网关 Chassis 从提供外部连接的逻辑交换机的 `localnet` 端口接收数据包。数据包随后进入入口管道，然后进入 `localnet` 逻辑交换机（提供外部连接）的出口管道。数据包随后进入逻辑路由器数据路径的入口管道。

2.  逻辑路由器数据路径的入口管道应用 unNAT 规则。数据包随后进入入口管道，然后进入源 `localnet` 逻辑交换机的出口管道。由于源 VM 不驻留在网关 Chassis 中，数据包通过源逻辑交换机的 `localnet` 端口发出。

3.  源 Chassis 通过 `localnet` 端口接收数据包并将其发送到集成网桥。数据包进入入口管道，然后进入源 `localnet` 逻辑交换机的出口管道，最后传递到源 VM 端口。

作为 `reside-on-redirect-chassis` 的替代方案，OVN 支持基于 VLAN 的重定向。`reside-on-redirect-chassis` 集中所有路由器功能，而基于 VLAN 的重定向仅更改 OVN 将数据包重定向到网关 Chassis 的方式。通过在分布式网关端口上将 `options:redirect-type` 设置为 `bridged`，OVN 使用路由器对等逻辑交换机的 `localnet` 端口而不是隧道将数据包重定向到网关 Chassis。

如果逻辑路由器没有连接到提供外部连接的 `localnet` 逻辑交换机的分布式网关端口，或者如果它有多个分布式网关端口，则 OVN 会忽略此选项。

对于桥接重定向，发生以下情况：

1.  在计算 Chassis 上，数据包通过逻辑路由器的入口管道。

2.  如果逻辑出口端口是网关 Chassis 附加的路由器端口，则数据包使用对等逻辑交换机的 `localnet` 端口“重定向”到网关 Chassis。

3.  此重定向数据包具有目标 mac 为路由器端口 mac（网关 Chassis 附加到的那个）。其 VLAN id 是 `localnet` 端口（逻辑路由器端口的对等逻辑交换机）的 VLAN id。

4.  在网关 Chassis 上，数据包将再次进入逻辑路由器管道，这次它也将通过出口管道。

5.  反向流量数据包流保持不变。

关于桥接重定向的一些准则和期望：

1.  由于路由器端口 mac 是目标 mac，因此必须确保物理网络仅从网关 Chassis 学习它。这意味着应在所有计算节点上配置 `ovn-chassis-mac-mappings`，以便物理网络永远不会从计算节点学习路由器端口 mac。

2.  由于数据包进入逻辑路由器入口管道两次（一次在计算 Chassis 上，另一次在网关 Chassis 上），因此 ttl 将递减两次。

3.  默认重定向类型仍然是 overlay。用户可以通过更改 `options:redirect-type` 的值在 bridged 和 overlay 之间切换重定向类型。
