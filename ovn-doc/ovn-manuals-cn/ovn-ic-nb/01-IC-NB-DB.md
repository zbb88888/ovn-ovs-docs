# OVN_IC_Northbound 数据库模式

此数据库是云管理系统（CMS）（如 OpenStack）配置 OVN 互连设置的接口。CMS 生成数据库的几乎所有内容。`ovn-ic` 程序监视数据库内容，对其进行转换，并将其存储到 `OVN_IC_Southbound` 数据库中。

我们通常所说的“CMS”，但可以想象多个 CMS 管理 OVN 互连的不同部分的场景。

## 外部 ID (External IDs)

此数据库中的每个表都包含一个名为 `external_ids` 的特殊列。此列在出现的每个位置都具有相同的形式和用途。

-   `external_ids`: 字符串对映射
    供 CMS 使用的键值对。例如，CMS 可能会使用某些对来识别其自身配置中与此数据库中的实体相对应的实体。

## 表摘要

下表总结了 OVN_IC_Northbound 数据库中每个表的用途。每个表都在后面的页面上有更详细的描述。

| 表 | 用途 |
| :--- | :--- |
| `IC_NB_Global` | IC 北向配置 |
| `Transit_Switch` | 中转逻辑交换机 |
| `Transit_Router` | 中转逻辑路由器 |
| `Transit_Router_Port` | 中转逻辑路由器端口 |
| `SSL` | SSL 配置 |
| `Connection` | OVSDB 客户端连接 |

---

# IC_NB_Global 表

OVN 互连的北向配置。此表必须只有一行。

## 摘要

**状态：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `nb_ic_cfg` | 整数 | 北向 IC 配置序列号。 |
| `sb_ic_cfg` | 整数 | 南向 IC 配置序列号。 |

**公共列：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `external_ids` | 字符串对映射 | 外部 ID。 |

**公共选项：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `options` | 字符串对映射 | 选项。 |
| `options : ic_probe_interval` | 可选字符串 | IC 探测间隔。 |
| `options : vxlan_mode` | 可选字符串 | VXLAN 模式。 |

**连接选项：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `connections` | `Connection` 的集合 | 连接集合。 |
| `ssl` | 可选 `SSL` | SSL 配置。 |

## 详细信息

### 状态

这些列允许客户端跟踪系统的整体配置状态。

-   `nb_ic_cfg`: 整数
    供客户端递增的序列号。当客户端修改互连北向数据库配置并希望等待 OVN-IC 处理此更改并更新互连南向数据库时，它可以递增此序列号。

-   `sb_ic_cfg`: 整数
    一个 OVN-IC 在等待所有 OVN-IC 完成将其更改应用于互连南向数据库后，将其设置为 `nb_ic_cfg` 值的序列号。

### 公共列

-   `external_ids`: 字符串对映射
    参见本文件开头的外部 ID。

### 公共选项

-   `options`: 字符串对映射
    此列提供常规键/值设置。支持的选项将在下面单独描述。

-   `options : ic_probe_interval`: 可选字符串
    `ovn-ic` 到 OVN IC 北向和南向数据库连接的非活动探测间隔，以毫秒为单位。如果该值为零，则禁用连接保活功能。

    如果该值非零，则强制其值至少为 1000 毫秒。

-   `options : vxlan_mode`: 可选字符串
    此字段允许客户端启用 VXLAN 作为跨可用区流量的封装协议。默认值为 false。

### 连接选项

-   `connections`: `Connection` 的集合
    Open vSwitch 数据库服务器应连接到或应侦听的数据库客户端，以及应如何配置这些连接的选项。有关更多信息，请参阅 `Connection` 表。

-   `ssl`: 可选 `SSL`
    全局 SSL/TLS 配置。

---

# Transit_Switch 表

每一行代表一个用于不同 OVN 部署（可用区）之间互连的中转逻辑交换机。

## 摘要

**命名：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `name` | 字符串（表内必须唯一） | 名称。 |

**公共列：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `other_config` | 字符串对映射 | 其他配置。 |
| `external_ids` | 字符串对映射 | 外部 ID。 |

## 详细信息

### 命名

-   `name`: 字符串（表内必须唯一）
    唯一标识中转逻辑交换机的名称。

### 公共列

-   `other_config`: 字符串对映射

-   `external_ids`: 字符串对映射
    参见本文件开头的外部 ID。

---

# Transit_Router 表

每一行代表一个用于不同 OVN 部署（可用区）之间互连的中转逻辑路由器。

## 摘要

**命名：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `name` | 字符串（表内必须唯一） | 名称。 |
| `ports` | `Transit_Router_Port` 的集合 | 端口集合。 |

**公共列：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `other_config` | 字符串对映射 | 其他配置。 |
| `external_ids` | 字符串对映射 | 外部 ID。 |

## 详细信息

### 命名

-   `name`: 字符串（表内必须唯一）
    唯一标识中转逻辑路由器的名称。

-   `ports`: `Transit_Router_Port` 的集合
    路由器的端口。

### 公共列

-   `other_config`: 字符串对映射

-   `external_ids`: 字符串对映射
    参见本文件开头的外部 ID。

---

# Transit_Router_Port 表

每一行代表一个用于不同 OVN 部署（可用区）之间互连的中转逻辑路由器端口。

## 摘要

**命名：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `name` | 字符串（表内必须唯一） | 名称。 |
| `mac` | 字符串 | MAC 地址。 |
| `chassis` | 字符串 | Chassis。 |
| `tr_uuid` | uuid | TR UUID。 |
| `networks` | 字符串集合 | 网络集合。 |

**公共列：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `other_config` | 字符串对映射 | 其他配置。 |

## 详细信息

### 命名

-   `name`: 字符串（表内必须唯一）
    唯一标识中转逻辑路由器端口的名称。

-   `mac`: 字符串
    属于此路由器端口的以太网地址。

-   `chassis`: 字符串
    此路由器端口应绑定到的 Chassis。

-   `tr_uuid`: uuid
    这是此端口关联的北向 IC 逻辑数据路径的 UUID。

-   `networks`: 字符串集合
    路由器端口的 IP 地址和网络掩码。例如，`192.168.0.1/24` 表示路由器的 IP 地址是 `192.168.0.1`，发往 `192.168.0.x` 的数据包应路由到此端口。这些是可选的。

    逻辑路由器端口始终会自动添加一个链路本地 IPv6 地址 (fe80::/64)，该地址是使用修改后的 EUI-64 格式从接口的 MAC 地址生成的。

### 公共列

-   `other_config`: 字符串对映射

---

# SSL 表

用于 ovn-nb 数据库访问的 SSL/TLS 配置。

## 摘要

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `private_key` | 字符串 | 私钥。 |
| `certificate` | 字符串 | 证书。 |
| `ca_cert` | 字符串 | CA 证书。 |
| `bootstrap_ca_cert` | 布尔值 | 引导 CA 证书。 |
| `ssl_protocols` | 字符串 | SSL 协议。 |
| `ssl_ciphers` | 字符串 | SSL 密码。 |
| `ssl_ciphersuites` | 字符串 | SSL 密码套件。 |

**公共列：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `external_ids` | 字符串对映射 | 外部 ID。 |

## 详细信息

-   `private_key`: 字符串
    包含用作交换机对控制器的 SSL/TLS 连接身份的私钥的 PEM 文件名。

-   `certificate`: 字符串
    包含证书的 PEM 文件名，该证书由控制器和管理器使用的证书颁发机构 (CA) 签名，证明交换机的私钥，标识可信交换机。

-   `ca_cert`: 字符串
    包含 CA 证书的 PEM 文件名，用于验证交换机是否连接到可信控制器。

-   `bootstrap_ca_cert`: 布尔值
    如果设置为 true，则 Open vSwitch 将尝试在其第一个 SSL/TLS 连接上从控制器获取 CA 证书并将其保存到命名的 PEM 文件中。如果成功，它将立即断开连接并重新连接，从那时起，所有 SSL/TLS 连接都必须由由此获得的 CA 证书签名的证书进行身份验证。此选项将 SSL/TLS 连接暴露给获取初始 CA 证书的中间人攻击。它对于引导可能仍然有用。

-   `ssl_protocols`: 字符串
    要为 SSL/TLS 连接启用的 SSL/TLS 协议的范围或逗号或空格分隔的列表。

    支持的协议包括 TLSv1.2 和 TLSv1.3。范围可以以用破折号分隔的两个协议名称的形式提供 (TLSv1.2-TLSv1.3)，或者作为带有加号的单个协议名称 (TLSv1.2+)。该值可以是协议列表或恰好一个范围。范围是指定协议的首选方式，并且配置始终表现为好像提供了指定的最小和最大版本之间的范围，即，如果该值设置为 TLSv1.X,TLSv1.(X+2)，则 TLSv1.(X+1) 也将被启用，就像它是一个范围一样。无论顺序如何，建立连接时都会选择双方都支持的最高协议。

    当省略此选项时，默认为 TLSv1.2+。

-   `ssl_ciphers`: 字符串
    要为使用 TLSv1.2 的 SSL/TLS 连接支持的密码列表（采用 OpenSSL 密码字符串格式）。当省略此选项时，默认为 DEFAULT:@SECLEVEL=2。

-   `ssl_ciphersuites`: 字符串
    要为使用 TLSv1.3 及更高版本的 SSL/TLS 连接支持的密码套件列表（采用 OpenSSL 密码套件字符串格式）。当省略此选项时，将使用 OpenSSL 的默认值。

### 公共列

这些列的总体用途在本文件开头的“公共列”下进行了描述。

-   `external_ids`: 字符串对映射

---

# Connection 表

Open vSwitch 数据库 (OVSDB) 客户端的数据库连接配置。

此表主要配置 Open vSwitch 数据库服务器 (ovsdb-server)。

Open vSwitch 数据库服务器可以发起并维护到远程客户端的主动连接。它还可以侦听数据库连接。

## 摘要

**核心功能：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `target` | 字符串（表内必须唯一） | 目标。 |

**客户端故障检测和处理：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `max_backoff` | 可选整数，至少 1,000 | 最大回退时间。 |
| `inactivity_probe` | 可选整数 | 非活动探测。 |

**状态：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `is_connected` | 布尔值 | 是否已连接。 |
| `status : last_error` | 可选字符串 | 最后错误。 |
| `status : state` | 可选字符串，`ACTIVE`, `BACKOFF`, `CONNECTING`, `IDLE`, 或 `VOID` 之一 | 状态。 |
| `status : sec_since_connect` | 可选字符串，包含整数，至少 0 | 连接后秒数。 |
| `status : sec_since_disconnect` | 可选字符串，包含整数，至少 0 | 断开后秒数。 |
| `status : locks_held` | 可选字符串 | 持有的锁。 |
| `status : locks_waiting` | 可选字符串 | 等待的锁。 |
| `status : locks_lost` | 可选字符串 | 丢失的锁。 |
| `status : n_connections` | 可选字符串，包含整数，至少 2 | 连接数。 |
| `status : bound_port` | 可选字符串，包含整数 | 绑定端口。 |

**公共列：**

| 字段 | 类型 | 描述 |
| :--- | :--- | :--- |
| `external_ids` | 字符串对映射 | 外部 ID。 |
| `other_config` | 字符串对映射 | 其他配置。 |

## 详细信息

### 核心功能

-   `target`: 字符串（表内必须唯一）
    客户端的连接方法。

    目前支持以下连接方法：

    *   `ssl:host[:port]`
        给定主机上指定的 SSL/TLS 端口，可以是 DNS 名称（如果构建时使用了 unbound 库）或 IP 地址。使用此形式时必须提供有效的 SSL/TLS 配置，可以通过命令行选项或 SSL 表指定此配置。

        如果未指定端口，默认为 6640。

        SSL/TLS 支持是一个可选功能，并不总是作为 OVN 或 Open vSwitch 的一部分构建。

    *   `tcp:host[:port]`
        给定主机上指定的 TCP 端口，可以是 DNS 名称（如果构建时使用了 unbound 库）或 IP 地址。如果主机是 IPv6 地址，请将其括在方括号中，例如 `tcp:[::1]:6640`。

        如果未指定端口，默认为 6640。

    *   `pssl:[port][:host]`
        侦听指定 TCP 端口上的 SSL/TLS 连接。指定 0 作为端口以让内核自动选择可用端口。如果指定了主机（可以是 DNS 名称（如果构建时使用了 unbound 库）或 IP 地址），则连接仅限于解析的或指定的本地 IP 地址（IPv4 或 IPv6 地址）。如果主机是 IPv6 地址，请将其括在方括号中，例如 `pssl:6640:[::1]`。如果未指定主机，则仅侦听 IPv4（但不侦听 IPv6）地址。使用此形式时必须提供有效的 SSL/TLS 配置，可以通过命令行选项或 SSL 表指定此配置。

        如果未指定端口，默认为 6640。

        SSL/TLS 支持是一个可选功能，并不总是作为 OVN 或 Open vSwitch 的一部分构建。

    *   `ptcp:[port][:host]`
        侦听指定 TCP 端口上的连接。指定 0 作为端口以让内核自动选择可用端口。如果指定了主机（可以是 DNS 名称（如果构建时使用了 unbound 库）或 IP 地址），则连接仅限于解析的或指定的本地 IP 地址（IPv4 或 IPv6 地址）。如果主机是 IPv6 地址，请将其括在方括号中，例如 `ptcp:6640:[::1]`。如果未指定主机，则仅侦听 IPv4 地址。

        如果未指定端口，默认为 6640。

    当配置了多个客户端时，目标值必须是唯一的。重复的目标值产生未定义的结果。

### 客户端故障检测和处理

-   `max_backoff`: 可选整数，至少 1,000
    连接尝试之间等待的最大毫秒数。默认值取决于具体实现。

-   `inactivity_probe`: 可选整数
    向客户端发送非活动探测消息之前连接空闲时间的最大毫秒数。如果 Open vSwitch 在指定的秒数内未与客户端通信，它将发送探测。如果在相同的额外时间内未收到响应，Open vSwitch 假定连接已断开并尝试重新连接。默认值取决于具体实现。值 0 禁用非活动探测。

### 状态

-   `is_connected`: 布尔值
    如果当前已连接到此客户端，则为 true，否则为 false。

-   `status : last_error`: 可选字符串
    连接到管理器时发生的最后错误的易读描述；即 `strerror(errno)`。仅当发生错误时此键才存在。

-   `status : state`: 可选字符串，`ACTIVE`, `BACKOFF`, `CONNECTING`, `IDLE`, 或 `VOID` 之一
    到管理器的连接状态：

    *   `VOID`: 连接已禁用。
    *   `BACKOFF`: 尝试以增加的时间段重新连接。
    *   `CONNECTING`: 正在尝试连接。
    *   `ACTIVE`: 已连接，远程主机响应。
    *   `IDLE`: 连接空闲。等待保活响应。

    这些值将来可能会更改。它们仅供人类使用。

-   `status : sec_since_connect`: 可选字符串，包含整数，至少 0
    自此客户端上次成功连接到数据库以来的时间（秒）。如果客户端从未成功连接，则值为空。

-   `status : sec_since_disconnect`: 可选字符串，包含整数，至少 0
    自此客户端上次从数据库断开连接以来的时间（秒）。如果客户端从未断开连接，则值为空。

-   `status : locks_held`: 可选字符串
    连接持有的 OVSDB 锁名称的空格分隔列表。如果连接未持有任何锁，则省略。

-   `status : locks_waiting`: 可选字符串
    连接当前正在等待获取的 OVSDB 锁名称的空格分隔列表。如果连接未等待任何锁，则省略。

-   `status : locks_lost`: 可选字符串
    被另一个 OVSDB 客户端从连接中窃取的 OVSDB 锁名称的空格分隔列表。如果没有从该连接窃取锁，则省略。

-   `status : n_connections`: 可选字符串，包含整数，至少 2
    当目标指定侦听入站连接的连接方法（例如 `ptcp:` 或 `pssl:`）并且实际上有多个连接处于活动状态时，该值是活动连接数。否则，省略此键值对。

-   `status : bound_port`: 可选字符串，包含整数
    当目标是 `ptcp:` 或 `pssl:` 时，这是 OVSDB 服务器正在侦听的 TCP 端口。（这在目标指定端口 0 以允许内核选择任何可用端口时特别有用。）

### 公共列

这些列的总体用途在本文件开头的“公共列”下进行了描述。

-   `external_ids`: 字符串对映射

-   `other_config`: 字符串对映射
